<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Deal Timer Tracker – Firebase Version</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button, select { margin: 5px; padding: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #f4f4f4; }
    input.finance-input { width: 120px; }
  </style>
</head>
<body>

<h2>Deal Timer Tracker (Shared via Firebase)</h2>

<label>Select Date: <input type="date" id="selectedDate"></label>
<br><br>
<label>Stock Number: <input type="text" id="stockNumber"></label>
<label>Sales Manager: <input type="text" id="salesManager"></label>
<button onclick="dropDeal()">Drop Deal</button>

<table>
  <thead>
    <tr>
      <th>Stock #</th>
      <th>Sales Manager</th>
      <th>Finance Manager</th>
      <th>Dropped At</th>
      <th>Picked Up At</th>
      <th>Finished At</th>
      <th>Time to Pickup</th>
      <th>Time to Finish</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="dealTableBody"></tbody>
</table>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
  // ✅ Your Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAktoYwM1PnW1W3zMcCyeaiMXpg8tTXt4",
    authDomain: "financetimer.firebaseapp.com",
    projectId: "financetimer",
    storageBucket: "financetimer.appspot.com",
    messagingSenderId: "303754960807",
    appId: "1:303754960807:web:6edbd2bb78dcfda5ddc2",
    measurementId: "G-38X1YPEP2Z"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function getDateKey() {
    return document.getElementById("selectedDate").value;
  }

  document.getElementById("selectedDate").value = new Date().toISOString().split("T")[0];
  document.getElementById("selectedDate").addEventListener("change", fetchDeals);

  function formatTime(ts) {
    return ts && ts.toDate ? ts.toDate().toLocaleTimeString() : '';
  }

  function timeDiff(startTS, endTS) {
    if (!startTS || !endTS || !startTS.toDate || !endTS.toDate) return '';
    const diff = (endTS.toDate() - startTS.toDate()) / 1000;
    const min = Math.floor(diff / 60);
    const sec = Math.floor(diff % 60);
    return `${min}m ${sec}s`;
  }

  async function dropDeal() {
    const stock = document.getElementById("stockNumber").value;
    const sales = document.getElementById("salesManager").value;
    const dateKey = getDateKey();

    if (!stock || !sales) return alert("Please enter all fields.");

    await db.collection("deals").add({
      stock,
      sales,
      finance: "",
      droppedAt: firebase.firestore.Timestamp.now(),
      pickedUpAt: null,
      finishedAt: null,
      date: dateKey
    });

    document.getElementById("stockNumber").value = '';
    document.getElementById("salesManager").value = '';
  }

  async function setFinanceManagerAndPickUp(id) {
    const input = document.getElementById(`financeInput-${id}`);
    const name = input.value.trim();
    if (!name) return alert("Enter Finance Manager name.");

    await db.collection("deals").doc(id).update({
      finance: name,
      pickedUpAt: firebase.firestore.Timestamp.now()
    });
  }

  async function finishDeal(id) {
    await db.collection("deals").doc(id).update({
      finishedAt: firebase.firestore.Timestamp.now()
    });
  }

  function fetchDeals() {
    const dateKey = getDateKey();

    db.collection("deals")
      .where("date", "==", dateKey)
      .onSnapshot(snapshot => {
        const tbody = document.getElementById("dealTableBody");
        tbody.innerHTML = '';

        const sortedDocs = snapshot.docs.sort((a, b) => {
          const d1 = a.data().droppedAt?.toDate?.() || new Date(0);
          const d2 = b.data().droppedAt?.toDate?.() || new Date(0);
          return d1 - d2;
        });

        sortedDocs.forEach(doc => {
          const deal = doc.data();
          const id = doc.id;

          const row = document.createElement("tr");

          const financeCell = !deal.pickedUpAt
            ? `<input class="finance-input" type="text" id="financeInput-${id}" value="${deal.finance}" placeholder="Enter name">
               <br>
               <button onclick="setFinanceManagerAndPickUp('${id}')">Pick Up</button>`
            : deal.finance;

          const actions = deal.pickedUpAt && !deal.finishedAt
            ? `<button onclick="finishDeal('${id}')">Finish</button>`
            : deal.finishedAt ? "Completed" : '';

          row.innerHTML = `
            <td>${deal.stock}</td>
            <td>${deal.sales}</td>
            <td>${financeCell}</td>
            <td>${formatTime(deal.droppedAt)}</td>
            <td>${formatTime(deal.pickedUpAt)}</td>
            <td>${formatTime(deal.finishedAt)}</td>
            <td>${timeDiff(deal.droppedAt, deal.pickedUpAt)}</td>
            <td>${timeDiff(deal.pickedUpAt, deal.finishedAt)}</td>
            <td>${actions}</td>
          `;
          tbody.appendChild(row);
        });
      });
  }

  // Load today's data on startup
  fetchDeals();
</script>

</body>
</html>
